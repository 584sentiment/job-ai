// Prisma Schema - 求职追踪助手数据库模型定义
// 与前端 web/src/types/ 保持一致

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id            String    @id @default(uuid())
  phone         String    @unique
  password      String
  nickname      String
  avatar        String?
  bio           String?
  email         String?
  createTime    BigInt    @default(0)
  updateTime    BigInt    @default(0)

  // 关联关系
  positions        Position[]
  interviews       Interview[]
  experiences      Experience[]
  experienceComments ExperienceComment[]
  commentReplies   ExperienceComment[] @relation("CommentReplies")
  summaries        Summary[]

  @@map("users")
}

// 岗位表
model Position {
  id            String    @id @default(uuid())
  userId        String

  // 基本信息（前端字段名：company -> companyName）
  companyName   String
  positionName  String
  deliveryChannel String
  deliveryDate  BigInt    // 投递日期时间戳
  workLocation  String?
  salaryRange   String?
  jobDescription String?  @db.Text

  // 联系人信息
  contactName   String?
  contactPhone  String?

  // 备注
  remarks       String?   @db.Text

  // 状态
  status        String    @default("pending") // pending, applied, interview, offered, rejected
  isCollected   Int       @default(0) // 0: 否, 1: 是（前端使用 number）

  // 时间戳（毫秒）
  createTime    BigInt    @default(0)
  updateTime    BigInt    @default(0)

  // 关联关系
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviews    Interview[] @relation("PositionInterviews")
  experiences   Experience[] @relation("PositionExperiences")
  summaries     Summary[]   @relation("PositionSummaries")

  @@index([userId])
  @@index([status])
  @@map("positions")
}

// 面试记录表
model Interview {
  id            String    @id @default(uuid())
  positionId    String
  userId        String

  // 面试信息（前端字段名调整）
  interviewRound String   // 笔试、一面、二面、三面、终面
  interviewTime BigInt    // 时间戳（毫秒）
  interviewLocation String
  interviewForm   String  // 现场面试、视频面试、电话面试
  interviewerInfo String? @db.Text // 面试官信息

  // 备注
  remarks       String?   @db.Text

  // 状态
  status        Int       @default(0) // 前端使用 number

  // 时间戳（毫秒）
  createTime    BigInt    @default(0)
  updateTime    BigInt    @default(0)

  // 关联关系
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  position      Position  @relation("PositionInterviews", fields: [positionId], references: [id], onDelete: Cascade)
  summaries     Summary[] @relation("SummaryInterview")

  @@index([userId])
  @@index([positionId])
  @@index([interviewTime])
  @@map("interviews")
}

// 面经表
model Experience {
  id            String    @id @default(uuid())
  positionId    String?
  userId        String

  // 基本信息（前端字段名调整）
  companyName   String
  positionName  String
  interviewRound String   // 笔试、一面、二面、三面、HR面
  interviewDate BigInt    // 面试日期时间戳

  // 面经内容
  content       String    @db.Text
  contentType   String    @default("markdown") // text, markdown, html

  // 标签
  tags          String[]  @default([])

  // 状态（前端字段名调整）
  isFavorite    Int       @default(0) // 0: 否, 1: 是
  isAnonymous   Int       @default(0) // 0: 否, 1: 是

  // 统计（前端字段名调整）
  views         Int       @default(0)
  comments      Int       @default(0)

  // 时间戳（毫秒）
  createTime    BigInt    @default(0)
  updateTime    BigInt    @default(0)

  // 关联关系
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  position      Position? @relation("PositionExperiences", fields: [positionId], references: [id], onDelete: SetNull)
  commentList   ExperienceComment[]

  @@index([userId])
  @@index([positionId])
  @@index([interviewDate])
  @@index([createTime])
  @@map("experiences")
}

// 面经评论表
model ExperienceComment {
  id            String    @id @default(uuid())
  experienceId  String
  userId        String

  // 回复关系（支持多级评论）
  parentId      String?
  replyToUserId String?

  // 评论内容
  content       String    @db.Text

  // 统计
  likes         Int       @default(0)

  // 时间戳（毫秒）
  createTime    BigInt    @default(0)
  updateTime    BigInt    @default(0)

  // 关联关系
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  experience    Experience  @relation(fields: [experienceId], references: [id], onDelete: Cascade)
  replyToUser   User?       @relation("CommentReplies", fields: [replyToUserId], references: [id], onDelete: SetNull)
  parent        ExperienceComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies       ExperienceComment[] @relation("CommentReplies")

  @@index([userId])
  @@index([experienceId])
  @@index([parentId])
  @@map("experience_comments")
}

// 面试总结表
model Summary {
  id            String    @id @default(uuid())
  positionId    String?
  interviewId   String?
  userId        String

  // 基本信息
  companyName   String
  positionName  String
  interviewRound String?

  // 总结内容（结构化数据，JSON 格式）
  // {
  //   "content": "总结内容",
  //   "highlights": ["亮点1", "亮点2"],
  //   "improvements": ["改进点1", "改进点2"]
  // }
  content       Json
  round         String?
  date          BigInt?    // 面试日期时间戳

  // 时间戳（毫秒）
  createTime    BigInt    @default(0)
  updateTime    BigInt    @default(0)

  // 关联关系
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  interview     Interview? @relation("SummaryInterview", fields: [interviewId], references: [id], onDelete: SetNull)
  position      Position?  @relation("PositionSummaries", fields: [positionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([interviewId])
  @@index([positionId])
  @@map("summaries")
}
